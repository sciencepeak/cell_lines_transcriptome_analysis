---
title: "A good title to conceive"
author: "Author: Old Vegetable Bird"
date: "`r format(Sys.time(), '%F')`"
output:
    rmarkdown::html_document:
        theme: readable
        highlight: textmate
        df_print: paged
---

# initial settings

```{r warning=F, message=F}
rm(list = ls())
ptm <- proc.time()
# proc.time() - ptm
options(stringsAsFactors = F)
library("magrittr")
library("readxl")
library("edgeR")
library("limma")
library("R.utils")
library("ggfortify")
library("tibble")
library("hash")
library("rgl")
# library("gplots")
```

# Understand batch effect

![batch effect](diagrams/batch_effect.png)



# Set up input and output files and directories.

```{r}
grouping_path <- file.path("..", "01_cloud_workflow", "metadata", "samples_cell_lines_batch_both_SampleGroup.xlsx")
expression_path <- file.path(".", "intermediate_files", "gene_expression_matrix.raw_count.csv.bz2")

output_directory <- file.path(".", "intermediate_files")
output_csv_file_name <- "gene_expression_matrix.log2_cpm.csv"
output_3D_PCA_graph_name <- "3D_PCA_graph.png"
```

# Read the files from hard disk.

```{r}
raw_expression_dataframe <- read.csv(expression_path, row.names = 1, check.names = F)
grouping_dataframe <- read_excel(grouping_path)

grouping_hash <- hash(keys = grouping_dataframe$File, values = grouping_dataframe$Batch)
```

# Normalization using cpm funcion in edgeR package

```{r}
# normalized_expression_matrix <- cpm(raw_expression_dataframe, log = T, prior.count = 0.001)
normalized_expression_matrix <- raw_expression_dataframe %>%
    DGEList %>%
    calcNormFactors %>%
    cpm(., normalized.lib.sizes=TRUE, prior.count=0.001, log=TRUE)
```

# Remove batch effect using removeBatchEffect function in limma package

```{r}
batch_factor_vector <- values(grouping_hash, keys = colnames(normalized_expression_matrix))
batch_effect_removed_normalized_expression_matrix <-
    removeBatchEffect(normalized_expression_matrix, batch = batch_factor_vector)

```

# Remove weird genes such as pseudogenes and unconfirmed genes.

```{r}
all_genes <- rownames(batch_effect_removed_normalized_expression_matrix)

remaining_genes <- grep("^[A-Z][A-Z1-9]+[.][1-9]+", all_genes, perl=TRUE, value=TRUE, invert=TRUE)
remaining_genes <- grep("\\.", remaining_genes, perl=TRUE, value=TRUE, invert=TRUE)
remaining_genes <- grep("^MT-*[A-Z1-9]+", remaining_genes, perl=TRUE, value=TRUE, invert=TRUE)
remaining_genes <- grep("hsa-mir", remaining_genes, perl=TRUE, value=TRUE, invert=TRUE)
remaining_genes <- grep("^MIR\\d+", remaining_genes, perl=TRUE, value=TRUE, invert=TRUE)
remaining_genes <- grep("^RNA\\d+[A-Z1-9]+", remaining_genes, perl=TRUE, value=TRUE, invert=TRUE)
remaining_genes <- grep("^RNU\\d+", remaining_genes, perl=TRUE, value=TRUE, invert=TRUE)
remaining_genes <- grep("^RNVU\\d+", remaining_genes, perl=TRUE, value=TRUE, invert=TRUE)
remaining_genes <- grep("^RNY\\d+", remaining_genes, perl=TRUE, value=TRUE, invert=TRUE)
remaining_genes <- grep("^HNRN", remaining_genes, perl=TRUE, value=TRUE, invert=TRUE)
remaining_genes <- grep("^SNOR[A-Z]\\d+[A-Z1-9]*", remaining_genes, perl=TRUE, value=TRUE, invert=TRUE)
remaining_genes <- grep("^LOC\\d+[A-Z1-9]+", remaining_genes, perl=TRUE, value=TRUE, invert=TRUE)
remaining_genes <- grep("^LINC\\d+[A-Z1-9]+", remaining_genes, perl=TRUE, value=TRUE, invert=TRUE)
remaining_genes <- grep("^SCARNA\\d+[A-Z1-9]*", remaining_genes, perl=TRUE, value=TRUE, invert=TRUE)
remaining_genes <- grep("[A-Z1-9]+-[A-Z1-9][A-Z1-9]+", remaining_genes, perl=TRUE, value=TRUE, invert=TRUE)

## remove genes that are pseudo genes/unconfirmed
corrected_expression_dataframe <- batch_effect_removed_normalized_expression_matrix %>%
    .[remaining_genes, , drop = F] %>%
    as.data.frame
```

# Identify genes with high variability

compute IQR, max value

```{r}
temporary_expression_dataframe <- corrected_expression_dataframe

temporary_expression_dataframe$IQR <- apply(corrected_expression_dataframe, 1, IQR)
temporary_expression_dataframe$max <- apply(corrected_expression_dataframe, 1, max)

#sort by IQR, because we are more interested in higher variance genes
temporary_expression_dataframe <- temporary_expression_dataframe %>%
    .[order(.$IQR, decreasing=T), ]

## remove gene with log2 CPM < 0, and also choose those with IQR >= 1
temporary_expression_dataframe <- temporary_expression_dataframe[temporary_expression_dataframe$max >= 0, ]
temporary_expression_dataframe <- temporary_expression_dataframe[temporary_expression_dataframe$IQR >= 1, ]

temporary_expression_dataframe$max <- NULL
temporary_expression_dataframe$IQR <-  NULL
```

# Remove the outlier

```{r}
temporary_expression_dataframe[, "M238-CTRL-1hr"] <- NULL
```


```{r}
write.csv(temporary_expression_dataframe,
          file = output_csv_file_name,
          quote = F,
          row.names = T)

output_compressed_file_name <- bzip2(output_csv_file_name, compression = 9, overwrite = T)[1]
output_compressed_file_name

file.rename(from = output_compressed_file_name,
            to = file.path(output_directory, output_compressed_file_name))
```


# PCA analysis

```{r}
##remove IQR and max column, choose the top 5000 genes based on IQR
transposed_dataframe <- temporary_expression_dataframe[1:5000, ] %>%
    t %>%
    as.data.frame
labelled_dataframe <- rownames_to_column(transposed_dataframe, var = "Batch") %>%
    inset(., "Batch", value = as.factor(values(grouping_hash, keys = .$Batch)))
```


# PCA plot using ggplot2 graphics

https://aaronschlegel.me/principal-component-analysis-r-example.html

https://cran.r-project.org/web/packages/ggfortify/vignettes/plot_pca.html


```{r}
pca_result <- prcomp(labelled_dataframe[, -1], scale. = T)
str(pca_result)
pca_plot <- autoplot(pca_result, data = labelled_dataframe, colour = "Batch")
pca_plot
```



# PCA plot using base graphics

```{r}
## the PCA computation, use scaling
pca.res<-prcomp(labelled_dataframe[, -1],scale.=T,retx=T)
pc.var<-pca.res$sdev^2

#percentage of variance explained 
pc.per<-round(pc.var/sum(pc.var)*100, 1)
x<-as.data.frame(pca.res$x)

plot.default(x$PC1,x$PC2,type="p",pch=c(21),
             bg=c("red","black")[labelled_dataframe$Batch],
             col="white",
             lwd=2,cex=2.5,xaxs="r",yaxs="r",bty="l",
             cex.axis=1,cex.main=1,cex.lab=1,font.lab=2,font.axis=2)
```

# 3D PCA using package rgl

```{r}
plot3d(x$PC1,x$PC2,x$PC3,type="s",col=c("red","black")[labelled_dataframe$Batch],size=2)
grid3d("x")
grid3d("y+")
grid3d("z")
rgl.snapshot(file.path(output_directory, output_3D_PCA_graph_name))
```


```{r}
proc.time() - ptm
```

